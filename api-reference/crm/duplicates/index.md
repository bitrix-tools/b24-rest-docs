# Поиск и обработка дубликатов в CRM: обзор методов 

При работе с большой базой клиентов некоторые элементы CRM, такие как лиды, контакты или компании, могут повторяться. Первый звонок клиента создает контакт с именем и номером телефона. Письмо от этого же клиента создает новый контакт, с именем и e-mail адресом  — это дубликат.  Дубликаты контактов можно объединть. 

> Быстрый переход: [все методы и события](#all-methods)
> 
> Пользовательская документация: [поиск и обработка дубликатов в Битрикс24](https://helpdesk.bitrix24.ru/open/10649014/) 

## Настройка поиска дубликатов в CRM

В интерфейсе Битрикс24 поиск дубликатов доступен для трех объектов CRM: лиды, контакты, компании. 

При запуске поиска сотрудник может выбрать, на основании каких полей будут отбираться дубликаты:

* **Лиды** — Ф.И.О., название компании, телефон, e-mail
* **Контакты** — Ф.И.О., телефон, e-mail, ИНН, ОГРНИП и расчетный счет
* **Компании** — название компании, телефон, e-mail, ИНН, ОГРН и расчетный счет

С помощью REST-методов можно расширить настройки поиска дубликатов в Битрикс24, добавив к ним дополнительные поля, в том числе пользовательские. Дополнительные поля в настройках поиска появятся в интерфейсе у всех сотрудников.

Чтобы получить перечень стандартных и пользовательских полей, по которым можно искать дубликаты, выполните метод [crm.duplicate.volatileType.fields](./volatile-type/crm-duplicate-volatile-type-fields.md).

Чтобы получить перечень нестандартных полей, по которым поиск уже работает, выполните метод [crm.duplicate.volatileType.list](./volatile-type/crm-duplicate-volatile-type-list.md).

Добавить поле к поиску дубликатов можно через метод [crm.duplicate.volatileType.register](./volatile-type/crm-duplicate-volatile-type-register.md), удалить поле из поиска — [crm.duplicate.volatileType.unregister](./volatile-type/crm-duplicate-volatile-type-unregister.md).

## Поиск дубликатов через REST

Для поиска дубликатов через приложение или вебхук используйте метод [crm.duplicate.findbycomm](./crm-duplicate-find-by-comm.md). Метод позволяет искать дубликаты только по email-адресу и номеру телефона. 

Метод crm.duplicate.findbycomm можно использовать для выбора элемента CRM. Например, у вас есть [дело c типом письмо](../timeline/activities/index.md), поступившее с почты test@bitrix.com. Чтобы сохранить в CRM это письмо и не создать дубликат, необходимо проверить, есть ли в базе клиентов лид, контакт или компания с таким e-mail. Один и тот же e-mail может быть записан у контакта и у связанной с ним компании. Выполнив запрос crm.duplicate.findbycomm, вы получите ID обоих элементов с указанием их типов и сможете выбрать, в контакт или компанию лучше прикрепить ваше письмо. 

{% note tip "Туториал по работе с методом" %}

- [Как искать в CRM по телефону и e-mail](../../../tutorials/crm/how-to-get-lists/search-by-phone-and-email.md)

{% endnote %}

## Объединение дубликатов

Для объединения дубликатов используйте метод [crm.entity.mergeBatch](./crm-entity-merge-batch.md). Метод позволяет объединить несколько элементов одного типа. Можно объединить два лида, но нельзя объединить лид с контактом.

Полное автоматическое объединение доступно в нескольких случаях: 

* Элементы идентичны друг другу
* Элементы не идентичны, но разница в значениях полей не требует ручной обработки. Например, в одном элементе поле заполнено, а в другом это же поле пустое — будет сохранено значение из заполненного поля

Если автоматически объединить выбранные элементы невозможно из-за конфликта данных, причин может быть несколько: 

* в элементах есть заполненные поля c отличными значениями друг от друга. Проверить значения всех полей можно методом get, например для проверки полей лидов используйте метод [crm.lead.get](../leads/crm-lead-get.md)
* у пользователя, с аккаунта которого выполняется запрос на объединение, нет доступа к одному или нескольким полям

{% note tip "Пользовательская документация" %}

- [Как ограничить видимость пользовательских полей в CRM](https://helpdesk.bitrix24.ru/open/23204032/)
  
{% endnote %}

## Обзор методов {#all-methods}

> Scope: [`crm`](../../scopes/permissions.md)
>
> Кто может выполнять метод: любой пользователь с правом на изменение и удаление элементов CRM

### Поиск и объединение дубликатов

#|
|| **Метод** | **Описание** ||
|| [crm.duplicate.findbycomm](./crm-duplicate-find-by-comm.md) | Возвращает список дубликатов ||
|| [crm.entity.mergeBatch](./crm-entity-merge-batch.md) | Объединяет дубликаты ||
|#

### Настройка поиска дубликатов

#|
|| **Метод** | **Описание** ||
|| [crm.duplicate.volatileType.fields](./volatile-type/crm-duplicate-volatile-type-fields.md) | Возвращает список полей, по которым можно искать дубликаты ||
|| [crm.duplicate.volatileType.list](./volatile-type/crm-duplicate-volatile-type-list.md) | Возвращает список нестандартных полей, участвующих в поиске дубликатов ||
|| [crm.duplicate.volatileType.register](./volatile-type/crm-duplicate-volatile-type-register.md) | Добавляет поле в поиск дубликатов ||
|| [crm.duplicate.volatileType.unregister](./volatile-type/crm-duplicate-volatile-type-unregister.md) | Удаляет поле из поиска дубликатов ||
|#


