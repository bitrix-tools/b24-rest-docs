# Зарегистрировать звонок в Битрикс24 telephony.externalcall.register

{% note warning "Мы еще обновляем эту страницу" %}

Тут может не хватать некоторых данных — дополним в ближайшее время

{% endnote %}

{% if build == 'dev' %}

{% note alert "TO-DO _не выгружается на prod_" %}

- отсутствуют примеры
- отсутствует ответ в случае успеха
- отсутствует ответ в случае ошибки

{% endnote %}

{% endif %}

{% include notitle [Скоуп telephony all](./_includes/scope-telephony-all.md) %}

Метод `telephony.externalcall.register` регистрирует звонок в Битрикс24, для чего ищет в CRM соответствующий номеру объект. Если находит, то добавляет звонок в привязке к найденному объекту. Если не находит, то может автоматически создать лид.

При использовании `telephony.externalCall.register` ответственным за новый лид будет автоматически назначен первый ответственный за данного клиента ранее. Сменить такого ответственного можно в дальнейшем через [telephony.externalcall.finish](telephony-external-call-finish.md).

Одновременно с регистрацией звонка метод опционально может показать пользователю карточку звонка. Пользователь, которому показывается карточка, идентифицируется либо по `USER_ID`, либо по `USER_PHONE_INNER`. (То есть поля помечены как обязательные, но фактически нужно только одно из двух.)

Не нужно повторно вызывать этот метод для звонков, полученных на событии [OnExternalCallStart](./events/on-external-call-start.md). Эти звонки уже зарегистрированы в системе и для них надо вызывать только [telephony.externalcall.finish](telephony-external-call-finish.md) в конце звонка.

{% note warning %}

Повторный вызов `telephony.externalcall.register` с теми же параметрами, без закрытия предыдущего звонка методом `telephony.externalcall.finish`, выдает тот же `CALL_ID` в течение 30 минут.

{% endnote %}

Для создания дела "звонок" необходимо также вызывать метод `telephony.externalcall.finish`.

#|
|| **Параметр** / **Тип** | **Описание** ||
|| **USER_PHONE_INNER**^*^ 
[`string`](../data-types.md) | Внутренний номер пользователя. ||
|| **USER_ID**^*^ 
[`int`](../data-types.md) | Идентификатор пользователя. ||
|| **PHONE_NUMBER**^*^ 
[`string`](../data-types.md) | Номер телефона. ||
|| **CALL_START_DATE** 
[`string`](../data-types.md) | Дата/время звонка в формате iso8601. Обратите внимание, что в дате необходимо передавать часовой пояс, для избежания искажения времени звонка. Пример: `2021-02-03T18:25:10+03:00`. ||
|| **CRM_CREATE** 
[`int`](../data-types.md) | [0\/1] - Автоматическое создание в CRM сущности, связанной со звонком. При необходимости создает в CRM лид или сделку, в зависимости от [настроек и режима работы CRM](*mode).

 Обратите внимание, что дело звонка создается при любом значении этого параметра, если создание возможно. ||
|| **CRM_SOURCE** 
[`string`](../data-types.md) | STATUS_ID источника из справочника источников. Получить список источников можно методом `crm.status.list` с фильтром по "ENTITY_ID": "SOURCE". ||
|| **CRM_ENTITY_TYPE** 
[`string`](../data-types.md) | Тип объекта CRM, из карточки которого совершается звонок - CONTACT \| COMPANY \| LEAD. ||
|| **CRM_ENTITY_ID** 
[`int`](../data-types.md) | Идентификатор объекта CRM, тип которого указан в CRM_ENTITY_TYPE. ||
|| **SHOW** 
[`int`](../data-types.md) | [0/1] Показывать ли карточку звонка (по умолчанию 1). ||
|| **CALL_LIST_ID** 
[`int`](../data-types.md) | Идентификатор списка обзвона, к которому должен быть привязан звонок. ||
|| **LINE_NUMBER** 
[`string`](../data-types.md) | Номер внешней линии, через который совершался звонок (см. [telephony.externalLine.add](telephony-external-line-add.md)).

{% note warning %}

Значения из этого параметра используются в сценариях сквозной аналитики Битрикс24. Поэтому решения по интеграции с телефонией для каталога Приложения24 в обязательном порядке должны передавать здесь номер, на который был совершён регистрируемый входящий звонок. 

{% endnote %}

||
|| **TYPE**^*^ 
[`integer`](../data-types.md) | Тип звонка:
1 - исходящий
2 - входящий
3 - входящий с перенаправлением
4 - обратный ||
|#

{% include [Сноска о параметрах](../../_includes/required.md) %}

## Возвращаемые данные

#|
|| **Значение** / **Тип** | **Описание** ||
|| **CALL_ID** 
[`string`](../data-types.md) | Идентификатор звонка внутри Битрикс24. ||
|| **CRM_CREATED_LEAD** 
[`int`](../data-types.md) | Идентификатор созданного лида (создается, если в CRM не найден объект по входящему номеру). ||
|| **CRM_ENTITY_ID** 
[`int`](../data-types.md) | Идентификатор найденного в CRM объекта. ||
|| **CRM_ENTITY_TYPE** 
[`string`](../data-types.md) | Тип найденного в CRM объекта по входящему номеру CONTACT \| COMPANY \| LEAD. ||
|| **CRM_CREATED_ENTITIES** 
[`array`](../data-types.md) | Массив автоматически созданных в CRM сущностей при регистрации звонка. Формат:
- ENTITY_TYPE - тип созданной сущности
- ENTITY_ID - идентификатор созданной сущности ||
|| **LEAD_CREATION_ERROR** 
[`string`](../data-types.md) | Текст ошибки, возникшей при попытке создания лида в CRM. ||
|#

[*mode]: Существует: 
- простой режим (без лидов) - при котором будет создаваться сделка, а не лид;
- режим повторных продаж, при котором будет создавать сделка/лид даже если сущность в сrm найдена. (Но не будет создаваться если есть активная сделка/лид или номер внесен в черный список crm).
