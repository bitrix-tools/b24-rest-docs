# Концепция и преимущества обработки событий

> Быстрый переход: [все методы и события](#all-methods) 

Как узнать об изменении данных в Битрикс24? Например, о появлении новой сделки? Очевидный способ — сделать запрос, который вернет все сделки, дата создания которых позже указанного значения.

Однако такой способ получения данных требует разработки механизма на стороне приложения, который будет опрашивать Битрикс24 с заданной периодичностью. В случае тиражного решения, которое работает со многими порталами, задача может стать нетривиальной, а кроме того, ресурсоемкой. В том числе из-за того, что будет создавать повышенную нагрузку на опрашиваемые Битрикс24.

Но в REST API Битрикс24 есть отличная альтернатива. Такие изменение данных, как добавление новой сделки, изменение задачи, удаление товара и множество других, вызывают REST-события. Вы можете добавить собственные **обработчики событий** и оперативно узнавать и реагировать на такие изменения, чтобы:

- Синхронизировать данные внешней системы с изменениями в Битрикс24
- Запускать автоматическую обработку данных в Битрикс24
- Валидировать данные в Битрикс24 по правилам своей бизнес-логики
- И многое другое!

Обработчиком события служит URL, который будет вызван после того, как пользователь произведет запрошенное действие в Битрикс24.

{% note alert "Проверяйте доступность обработчиков" %}

Поскольку запросы будут идти с серверов Битрикс, то URL обработчика должен быть доступен для GET/POST запросов извне.

Нельзя использовать для обработки событий скрипты, размещенные на localhost или сервере, доступном только в рамках конкретной локальной сети. Обязательно проверяйте доступность своих обработчиков с помощью публичных сервисов «доступности сайта».

{% endnote %}

Нужно учитывать, что Битрикс24 не вызывает ваши обработчики в реальном времени, а сначала формирует отдельную очередь событий на специальном сервере и в дальнейшем эту очередь обрабатывает.

Возможна ситуация, когда обработчик получит вызов только через несколько секунд после реального события в Битрикс24.

Сервер очередей Битрикс24 также проверяет, как быстро отвечают ваши обработчики. И если они «отвечают» медленно, то дальнейший их вызов может выполняться с пониженным приоритетом, а следовательно, с более длительными паузами.

Текущие [адреса сервера очередей](../cloud-and-on-premise/network-access.md).

## Как работают события

Сначала приложение при помощи метода [event.bind](event-bind.md) устанавливает обработчик нужного события.

Затем, когда пользователь совершает соответствующее действие (создает задачу, изменяет задачу и так далее), Битрикс24 автоматически уведомляет об этом приложение через сервер очередей:

```mermaid
%%{init: { "theme": "forest" } }%%
sequenceDiagram
    autonumber
    actor Пользователь
    Приложение->>Битрикс24: Регистрирует обработчик / event.bind
    Пользователь-->>Битрикс24: Совершает действие XXX
    Битрикс24-->>Сервер Авторизации: Сообщает о событии XXX
    Сервер Авторизации-)Приложение: Передает информацию о событии XXX
```

## Что Битрикс24 отправляет в обработчик

В зависимости от конкретного события, Битрикс24 будет передавать в обработчик разный набор данных в ключе `data`. Чаще всего — это идентификатор объекта, измененного в Битрикс24.

Кроме этого, в обработчик в ключе `auth` обычно передаются параметры авторизации, в частности, [токены OAuth 2.0](../oauth/index.md):

```php
array(
    'event' => 'ONAPPINSTALL',
    'data' => array(
        'VERSION' => '1',
        'LANGUAGE_ID' => 'ru',
    ),
    'ts' => '1466439714',
    'auth' => array(
        'access_token' => 's6p6eclrvim6da22ft9ch94ekreb52lv',
        'expires_in' => '3600',
        'scope' => 'entity,im',
        'domain' => 'portal.bitrix24.com',
        'server_endpoint' => 'https://oauth.bitrix.info/rest/',
        'status' => 'F',
        'client_endpoint' => 'https://portal.bitrix24.com/rest/',
        'member_id' => 'a223c6b3710f85df22e9377d6c4f7553',
        'refresh_token' => '4s386p3q0tr8dy89xvmt96234v3dljg8',
        'application_token' => '51856fefc120afa4b628cc82d3935cce',
    ),
)
```

### Токены авторизации доступны не всегда

Возможная ситуация, когда обработчик события не получает токенов авторизации. Дело в том, что токены OAuth 2.0 всегда «принадлежат» [конкретному пользователю](../oauth/index.md) Битрикс24. Если изменение данных, вызвавшее событие, произошло на хите без авторизованного пользователя, Битрикс24 не может «понять», чьи токены ему следует передать в обработчик события.

Для того, чтобы ваше приложение продолжало работать даже в таких случаях, рекомендуется во время установки приложения в Битрикс24 сохранять токены пользователя, установившего ваше приложение, и использовать их.

## Исходящие вебхуки

Помимо установки обработчиков событий в приложениях с помощью метода `event.bind` есть более простой способ - [исходящие вебхуки](../../local-integrations/local-webhooks.md). Фактически, это тот же механизм событий, но обработчик может быть установлен через интерфейс раздела Разработчикам.

## Офлайн-события

Несмотря на очевидные преимущества механизма событий, у такого подхода есть и ряд недостатков.

Во-первых, вы не можете регулировать входящую нагрузку на свои обработчики событий.

Если вы подписались на изменение сделок и на портале вдруг одномоментно изменена тысяча сделок, то вы получите от Битрикс24 тысячу хитов на свой обработчик в достаточно интенсивном режиме.

Более того, если одна и та же сделка будет по каким-то причинам изменена подряд тысячу раз, вы получите тысячу хитов на свой обработчик.

Можете не справиться с нагрузкой.

Отсюда второй недостаток – если ваш сервер упал и не успел обработать все события, то Битрикс24 повторно уже ничего не пришлет. Сервер очередей зафиксирует на своей стороне, что обработчик приложения возвращает ошибку или не отвечает, и на этом все. Никакого второго шанса.

Если для вашей бизнес-логики жизненно важно обработать все события, то на помощь приходят [офлайн-события](offline-events.md)

## Продолжите изучение

- Вопросы [безопасности](safe-event-handlers.md)
- [Офлайн-события](offline-events.md)

## Обзор методов и событий {#all-methods}

{% list tabs %}

- Методы

    #|
    || **Метод** | **Описание** ||
    || [event.bind](./event-bind.md) | Регистрирует новый обработчик события ||
    || [event.get](./event-get.md) | Получает список зарегистрированных обработчиков событий ||
    || [event.offline.clear](./event-offline-clear.md) | Очищает записи в очереди офлайн-событий ||
    || [event.offline.error](./event-offline-error.md) | Регистрирует ошибки обработки очереди офлайн-событий ||
    || [event.offline.get](./event-offline-get.md) | Получает список офлайн-событий с «очисткой» ||
    || [event.offline.list](./event-offline-list.md) | Получает список офлайн-событий ||
    || [event.unbind](./event-unbind.md) | Отменяет зарегистрированный обработчик события ||
    || [events](./events.md) | Получает список доступных событий ||
    |#

- События

    #|
    || **Событие** | **Описание** ||
    || [onOfflineEvent](./on-offline-event.md) | При изменении очереди ||
    |#

{% endlist %}
